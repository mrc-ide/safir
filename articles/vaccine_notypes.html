<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vaccine model with multiple doses â€¢ safir</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Vaccine model with multiple doses">
<meta property="og:description" content="safir">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">safir</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/antibody_efficacy.html">Modeling of antibody titre and immunity</a>
    </li>
    <li>
      <a href="../articles/compare_nimue.html">Nimue Validation Run</a>
    </li>
    <li>
      <a href="../articles/compare_squire.html">Squire Validation Run</a>
    </li>
    <li>
      <a href="../articles/natural_immunity.html">Natural Immunity</a>
    </li>
    <li>
      <a href="../articles/vaccine_notypes.html">Vaccine model with multiple doses</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/safir/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="vaccine_notypes_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Vaccine model with multiple doses</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/safir/blob/master/vignettes/vaccine_notypes.Rmd"><code>vignettes/vaccine_notypes.Rmd</code></a></small>
      <div class="hidden name"><code>vaccine_notypes.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/safir">safir</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/individual">individual</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">nimue</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'nimue'</span>
<span class="co">#&gt; The following object is masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     format</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></code></pre></div>
<div id="setup" class="section level1">
<h1 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h1>
<p>Here we will set up the model with vaccinations. In this model only a single type of vaccine is distributed but it allows for arbitrary number of doses. At the end of this vignette we describe the dose allocation algorithm.</p>
<p>Start by making parameters. Note that <code>get_vaccine_ab_titre_parameters</code> gets parameters giving antibody titre and decay rates for each supported vaccine type, and that <code>make_vaccine_parameters</code> does final type checking and combines the different parameters into a single list for the simulation. The function <code>make_vaccine_parameters</code> uses a <code>strategy_matrix</code> which is the output of <a href="https://mrc-ide.github.io/nimue/articles/Coverage_and_Prioritisation.html">strategy_matrix in <strong>nimue</strong></a>. A user can either provide a single matrix that will give the strategy used to allocate all phases (all doses), or a list of matrices, one for each dosing phase.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iso3c</span> <span class="op">&lt;-</span> <span class="st">"GBR"</span>
<span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu">safir</span><span class="fu">::</span><span class="fu"><a href="../reference/get_population.html">get_population</a></span><span class="op">(</span><span class="va">iso3c</span><span class="op">)</span>
<span class="va">pop</span><span class="op">$</span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">pop</span><span class="op">$</span><span class="va">n</span> <span class="op">/</span> <span class="fl">1e3</span><span class="op">)</span>
<span class="va">contact_mat</span> <span class="op">&lt;-</span> <span class="fu">squire</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/squire/man/get_mixing_matrix.html">get_mixing_matrix</a></span><span class="op">(</span>iso3c <span class="op">=</span> <span class="va">iso3c</span><span class="op">)</span>

<span class="va">tmax</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">0.5</span>
<span class="va">R0</span> <span class="op">&lt;-</span> <span class="fl">4</span>

<span class="co"># vaccine dosing</span>
<span class="va">vaccine_doses</span> <span class="op">&lt;-</span> <span class="fl">2</span>
<span class="va">dose_period</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NaN</span>, <span class="fl">28</span><span class="op">)</span>
<span class="va">vaccine_set</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">1e3</span>, to <span class="op">=</span> <span class="fl">1e4</span>, length.out <span class="op">=</span> <span class="va">tmax</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">vaccine_set</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">vaccine_set</span><span class="op">)</span>

<span class="co"># vaccine strategy</span>
<span class="va">vaccine_coverage_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimue/man/strategy_matrix.html">strategy_matrix</a></span><span class="op">(</span>strategy <span class="op">=</span> <span class="st">"Elderly"</span>,max_coverage <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>
<span class="va">next_dose_priority</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">vaccine_doses</span> <span class="op">-</span> <span class="fl">1</span>,ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">vaccine_coverage_mat</span><span class="op">)</span><span class="op">)</span>
<span class="va">next_dose_priority</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">15</span><span class="op">:</span><span class="fl">17</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># prioritize 3 oldest age groups for next dose</span>

<span class="co"># base parameters</span>
<span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu">safir</span><span class="fu">::</span><span class="fu"><a href="../reference/get_parameters.html">get_parameters</a></span><span class="op">(</span>
  population <span class="op">=</span> <span class="va">pop</span><span class="op">$</span><span class="va">n</span>,
  contact_matrix_set <span class="op">=</span> <span class="va">contact_mat</span>,
  iso3c <span class="op">=</span> <span class="va">iso3c</span>,
  R0 <span class="op">=</span> <span class="va">R0</span>,
  time_period <span class="op">=</span> <span class="va">tmax</span>,
  dt <span class="op">=</span> <span class="va">dt</span>
<span class="op">)</span>

<span class="co"># vaccine parameters</span>
<span class="va">ab_parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_vaccine_ab_titre_parameters.html">get_vaccine_ab_titre_parameters</a></span><span class="op">(</span>vaccine <span class="op">=</span> <span class="st">"Pfizer"</span>, max_dose <span class="op">=</span> <span class="va">vaccine_doses</span>,correlated <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># combine parameters and verify</span>
<span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_vaccine_parameters.html">make_vaccine_parameters</a></span><span class="op">(</span>
  safir_parameters <span class="op">=</span> <span class="va">parameters</span>,
  vaccine_ab_parameters <span class="op">=</span> <span class="va">ab_parameters</span>,
  vaccine_set <span class="op">=</span> <span class="va">vaccine_set</span>,
  dose_period <span class="op">=</span> <span class="va">dose_period</span>,
  strategy_matrix <span class="op">=</span> <span class="va">vaccine_coverage_mat</span>,
  next_dose_priority_matrix <span class="op">=</span> <span class="va">next_dose_priority</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="run-safir" class="section level1">
<h1 class="hasAnchor">
<a href="#run-safir" class="anchor"></a>Run <strong>safir</strong>
</h1>
<p>Now we make the variables, events, and processes used in the model. In order to track the antibody titre for each vaccinated person, we use a custom function <code>double_count_render_process_daily</code> to write to the output matrix; this is because currently <strong>individual</strong> does not support renderers that track <code>DoubleVariable</code> objects. Unless the antibody titres are a direct object of analysis, it is recommended to not output them, as it slows down the simulation.</p>
<p>As usual, for actual use, please use only the minimum number of output/rendering needed for your analysis, as it increases run time. In particular, <code>double_count_render_process_daily</code> to output the antibody titre for each person each day is time consuming.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create variables</span>
<span class="va">timesteps</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">$</span><span class="va">time_period</span><span class="op">/</span><span class="va">dt</span>
<span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_variables.html">create_variables</a></span><span class="op">(</span>pop <span class="op">=</span> <span class="va">pop</span>, parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span>
<span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_vaccine_variables.html">create_vaccine_variables</a></span><span class="op">(</span>variables <span class="op">=</span> <span class="va">variables</span>,parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span>

<span class="co"># create events</span>
<span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_events.html">create_events</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span>
<span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_events_vaccination.html">create_events_vaccination</a></span><span class="op">(</span>events <span class="op">=</span> <span class="va">events</span>,parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span>
<span class="fu"><a href="../reference/attach_event_listeners.html">attach_event_listeners</a></span><span class="op">(</span>variables <span class="op">=</span> <span class="va">variables</span>,events <span class="op">=</span> <span class="va">events</span>,parameters <span class="op">=</span> <span class="va">parameters</span>, dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>
<span class="fu"><a href="../reference/attach_event_listeners_vaccination.html">attach_event_listeners_vaccination</a></span><span class="op">(</span>variables <span class="op">=</span> <span class="va">variables</span>,events <span class="op">=</span> <span class="va">events</span>,parameters <span class="op">=</span> <span class="va">parameters</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>

<span class="co"># make renderers</span>
<span class="va">renderer</span> <span class="op">&lt;-</span> <span class="va"><a href="https://mrc-ide.github.io/individual/reference/Render.html">Render</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">time_period</span><span class="op">)</span>
<span class="va">ab_renderer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="cn">NaN</span>,nrow <span class="op">=</span> <span class="va">parameters</span><span class="op">$</span><span class="va">time_period</span>,ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">population</span><span class="op">)</span><span class="op">)</span>
<span class="va">dose_renderer</span> <span class="op">&lt;-</span> <span class="va"><a href="https://mrc-ide.github.io/individual/reference/Render.html">Render</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">time_period</span><span class="op">)</span>

<span class="va">double_count_render_process_daily</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">variable</span>, <span class="va">dt</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">variable</span>, <span class="st">"DoubleVariable"</span><span class="op">)</span><span class="op">)</span>
  <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="op">(</span><span class="va">t</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">1</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">ab_renderer</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">t</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span>, <span class="op">]</span> <span class="op">&lt;&lt;-</span> <span class="va">variable</span><span class="op">$</span><span class="fu">get_values</span><span class="op">(</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="co"># processes</span>
<span class="va">processes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/vaccine_ab_titre_process.html">vaccine_ab_titre_process</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span>,variables <span class="op">=</span> <span class="va">variables</span>,events <span class="op">=</span> <span class="va">events</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/vaccination_process.html">vaccination_process</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span>,variables <span class="op">=</span> <span class="va">variables</span>,events <span class="op">=</span> <span class="va">events</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/infection_process_vaccine_cpp.html">infection_process_vaccine_cpp</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span>,variables <span class="op">=</span> <span class="va">variables</span>,events <span class="op">=</span> <span class="va">events</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/categorical_count_renderer_process_daily.html">categorical_count_renderer_process_daily</a></span><span class="op">(</span>renderer <span class="op">=</span> <span class="va">renderer</span>,variable <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">states</span>,categories <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">states</span><span class="op">$</span><span class="fu">get_categories</span><span class="op">(</span><span class="op">)</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>,
  <span class="fu">double_count_render_process_daily</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">ab_titre</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/integer_count_render_process_daily.html">integer_count_render_process_daily</a></span><span class="op">(</span>renderer <span class="op">=</span> <span class="va">dose_renderer</span>,variable <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">dose_num</span>,margin <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="va">vaccine_doses</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="../reference/setup_events_vaccine.html">setup_events_vaccine</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span>,events <span class="op">=</span> <span class="va">events</span>,variables <span class="op">=</span> <span class="va">variables</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span></code></pre></div>
<p>Run the simulation.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="../reference/simulation_loop_safir.html">simulation_loop_safir</a></span><span class="op">(</span>
    variables <span class="op">=</span> <span class="va">variables</span>,
    events <span class="op">=</span> <span class="va">events</span>,
    processes <span class="op">=</span> <span class="va">processes</span>,
    timesteps <span class="op">=</span> <span class="va">timesteps</span>,
    variables_dont_update <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"discrete_age"</span>, <span class="st">"phase"</span><span class="op">)</span>,
    progress <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;  10.886   0.199  11.097</span></code></pre></div>
<div id="plot-results" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-results" class="anchor"></a>Plot Results</h2>
<div id="antibody-titre" class="section level3">
<h3 class="hasAnchor">
<a href="#antibody-titre" class="anchor"></a>Antibody titre</h3>
<p>This lets us check if people are getting vaccinated; Ab titre, averaged over the population, relative to the time of the first dose. It wonâ€™t look like the cohort plots because everybody gets their second dose at slightly different times, depending on availability.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot: ab titre</span>
<span class="va">vaccinated</span> <span class="op">&lt;-</span> <span class="va">variables</span><span class="op">$</span><span class="va">dose_num</span><span class="op">$</span><span class="fu">get_index_of</span><span class="op">(</span>set <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="va">vaccinated</span> <span class="op">&lt;-</span> <span class="va">vaccinated</span><span class="op">$</span><span class="fu">not</span><span class="op">(</span>inplace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">ab_titre</span> <span class="op">&lt;-</span> <span class="va">ab_renderer</span><span class="op">[</span>, <span class="va">vaccinated</span><span class="op">$</span><span class="fu">to_vector</span><span class="op">(</span><span class="op">)</span><span class="op">]</span>
<span class="va">ab_titre</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.finite</a></span><span class="op">(</span><span class="va">ab_titre</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NaN</span>
<span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">ab_titre</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fl">0</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">2e-7</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">}</span><span class="op">)</span>
<span class="va">ab_titre</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">ab_titre</span><span class="op">)</span>,FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="va">ab_titre</span><span class="op">[</span><span class="va">start</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">ab_titre</span><span class="op">)</span> , <span class="va">x</span><span class="op">]</span>
<span class="op">}</span><span class="op">)</span>

<span class="va">ab_titre_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
  ab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">ab_titre</span><span class="op">)</span>,
  t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">ab_titre</span>, <span class="kw">function</span><span class="op">(</span><span class="va">ab_titre</span><span class="op">)</span><span class="op">{</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ab_titre</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span>,
  id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ab_titre</span><span class="op">)</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">ab_titre</span>,<span class="va">length</span>,<span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">ab_titre_quant_dt</span> <span class="op">&lt;-</span> <span class="va">ab_titre_dt</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ab</span><span class="op">)</span>, lo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">ab</span>,probs <span class="op">=</span><span class="fl">0.025</span><span class="op">)</span> , hi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">ab</span>,probs <span class="op">=</span> <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span> , by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">]</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ab_titre_quant_dt</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>,y<span class="op">=</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>,ymin<span class="op">=</span><span class="va">lo</span>,ymax<span class="op">=</span><span class="va">hi</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="vaccine_notypes_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
<div id="proportion-of-population-with-each-dose" class="section level3">
<h3 class="hasAnchor">
<a href="#proportion-of-population-with-each-dose" class="anchor"></a>Proportion of population with each dose</h3>
<p>We also want to plot the number of people with each dose over time to check itâ€™s working.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dose_out</span> <span class="op">&lt;-</span> <span class="va">dose_renderer</span><span class="op">$</span><span class="fu">to_dataframe</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dose_out</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="va">vaccine_doses</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="va">vaccine_doses</span><span class="op">)</span>
<span class="va">dose_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">dose_out</span><span class="op">)</span>,id.vars<span class="op">=</span><span class="st">"timestep"</span><span class="op">)</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span><span class="op">(</span><span class="va">dose_out</span>, <span class="st">"variable"</span>, <span class="st">"dose"</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dose_out</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">timestep</span>,y<span class="op">=</span><span class="va">value</span>,color<span class="op">=</span><span class="va">dose</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="vaccine_notypes_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div id="infection-states" class="section level3">
<h3 class="hasAnchor">
<a href="#infection-states" class="anchor"></a>Infection states</h3>
<p>The compartmental states of the model.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">saf_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">renderer</span><span class="op">$</span><span class="fu">to_dataframe</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">saf_dt</span><span class="op">[</span>, <span class="va">IMild_count</span> <span class="op">:=</span> <span class="va">IMild_count</span> <span class="op">+</span> <span class="va">IAsymp_count</span><span class="op">]</span>
<span class="va">saf_dt</span><span class="op">[</span>, <span class="va">IAsymp_count</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span>
<span class="va">saf_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt</a></span><span class="op">(</span><span class="va">saf_dt</span>,id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"timestep"</span><span class="op">)</span>,variable.name <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span>
<span class="va">saf_dt</span><span class="op">[</span>, <span class="va">name</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"(^)(\\w*)(_count)"</span>, <span class="st">"\\2"</span>, <span class="va">name</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">saf_dt</span>,old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"timestep"</span>,<span class="st">"name"</span>,<span class="st">"value"</span><span class="op">)</span>,new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"t"</span>,<span class="st">"compartment"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">saf_dt</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">t</span>,<span class="va">y</span>,color <span class="op">=</span> <span class="va">compartment</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">compartment</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></code></pre></div>
<p><img src="vaccine_notypes_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
</div>
</div>
<div id="code-design" class="section level1">
<h1 class="hasAnchor">
<a href="#code-design" class="anchor"></a>Code design</h1>
<div id="variables" class="section level2">
<h2 class="hasAnchor">
<a href="#variables" class="anchor"></a>Variables</h2>
<p><code>create_vaccine_variables</code> attaches various variable types and other data to the variables list needed to simulate vaccine allocation and antibody titre dynamics. It can be found in R/variables_vaccines.R.</p>
</div>
<div id="antibody-titre-dynamics-process" class="section level2">
<h2 class="hasAnchor">
<a href="#antibody-titre-dynamics-process" class="anchor"></a>Antibody titre dynamics process</h2>
<p>The process <code>vaccine_ab_titre_process</code> calculates daily updates for antibody titres for everyone in the population who has received at least one dose of the vaccine. For each vaccinated individual, the time since their last dose is found, which is used to find the daily decay rate which is used to update their Ab titre. Efficacy against infection and against severe disease are also calculated at this time.</p>
<p>New values for ab titres are drawn when individuals are given a vaccine dose, but these are found in <code>schedule_dose_vaccine</code> in R/events_vaccination.R and are described later.</p>
<p>The code can be found in R/efficacy_vaccination.R.</p>
</div>
<div id="vaccine-allocation-process" class="section level2">
<h2 class="hasAnchor">
<a href="#vaccine-allocation-process" class="anchor"></a>Vaccine allocation process</h2>
<p>The vaccine dose allocation algorithm is designed to be as similar as possible to the <a href="https://mrc-ide.github.io/nimue/reference/weighted_efficacy.html">weighted_efficacy function from <strong>nimue</strong></a>, generalized to an arbitrary number of doses. The vaccination process is <code>vaccination_process</code> and can be found in R/process_vaccination.R with many supporting functions in R/distribution_vaccines.R.</p>
<p>Vaccine dosing is split into phases, from 1 to the total number of doses. On phase <code>i</code>, dose <code>i</code> is administered to the population until conditions are met. In order to determine when to advance from phase <code>i</code> to <code>i+1</code>, a strategy matrix (coverage prioritisation matrix) is provided, which can be shared across all phases, or a unique strategy matrix for each phase. The strategy matrix used as input to <strong>safir</strong> is exactly the same as the one <a href="https://mrc-ide.github.io/nimue/articles/Coverage_and_Prioritisation.html">described in <strong>nimue</strong></a>, which is created using the <strong>nimue</strong> function <a href="https://mrc-ide.github.io/nimue/reference/strategy_matrix.html">strategy_matrix</a>. There is an additional piece of input <code>next_dose_priority</code> which describes which (if any) age groups are prioritized for dose <code>i+1</code> while still on phase <code>i</code> (similar to the argument <code>d2_prioritise</code> from <code>weighted_efficacy</code>).</p>
<p>In order to advance from phase <code>i</code> to <code>i+1</code>, each row (step) of the strategy matrix for that phase must have its coverage targets fulfilled. Additionally, those age groups specified by <code>next_dose_priority</code> must have their next dose coverage targets fulfilled at the same level given by each step of the strategy matrix. Because the strategy matrix will be stepped through before the phase can advance, when the phase goes from <code>i</code> to <code>i+1</code>, we are guaranteed that coverage targets for dose <code>i</code> (and prioritized targets for dose <code>i+1</code>, if any) have been met at the final row of the strategy matrix (the final step).</p>
<p>The algorithm distributes doses until all phases are complete, at which point no more doses are given, even if there is sufficient supply.</p>
<p>On a timestep, the algorithm has the following stages (<a href="https://github.com/mrc-ide/safir/blob/main/R/process_vaccination.R">see vaccination_process in R/process_vaccination.R</a>):</p>
<ol style="list-style-type: decimal">
<li>Given the current phase (dose) being distributed, find out what step of the prioritisation/strategy matrix the algorithm has attained, based on current coverage for that dose compared against coverage targets in the rows of the strategy matrix; if <code>next_dose_priority</code> has non-zero entries, compare those too for the next dose.</li>
<li>If all coverage targets (all rows) of the strategy matrix are fulfilled, step to the next dosing phase.</li>
<li>Based on this <code>step</code> of the strategy matrix for this <code>phase</code>, find eligible persons (based on what age groups are being targeted, and if the minimum inter-dose time interval has elapsed, if <code>phase &gt; 1</code>). Assign as many doses as possible to these persons.</li>
<li>If doses remain and this is not the last <code>phase</code>, assign the next dose to those persons prioritized based on <code>next_dose_priority</code>.</li>
<li>If doses remain, step through the remaining rows of the strategy matrix, assigning doses to individuals in groups that have not yet met their targets.</li>
</ol>
</div>
<div id="infection-process" class="section level2">
<h2 class="hasAnchor">
<a href="#infection-process" class="anchor"></a>Infection process</h2>
<p>The infection process can either use an R implementation <code>infection_process_vaccine</code> or C++ implementation <code>infection_process_vaccine_cpp</code>. The R version is in R/process_infection_vaccine.R and the C++ one in src/process_infection_vaccine.cpp.</p>
</div>
<div id="vaccine-events" class="section level2">
<h2 class="hasAnchor">
<a href="#vaccine-events" class="anchor"></a>Vaccine events</h2>
<p><code>create_events_vaccination</code> attaches additional <code><a href="https://mrc-ide.github.io/individual/reference/TargetedEvent.html">individual::TargetedEvent</a></code> objects to the events list to schedule doses for eligible individuals. <code>attach_event_listeners_vaccination</code> and <code>setup_events_vaccine</code> attach listeners and initialize the initial model state, respectively. These functions can be round in R/events_vaccination.R.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Sean L. Wu, OJ Watson, Peter Winskill.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
