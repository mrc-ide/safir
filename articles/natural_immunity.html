<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Natural Immunity • safir</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Natural Immunity">
<meta property="og:description" content="safir">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">safir</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.5.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/antibody_efficacy.html">Modeling of antibody titre and immunity</a>
    </li>
    <li>
      <a href="../articles/compare_nimue.html">Nimue Validation Run</a>
    </li>
    <li>
      <a href="../articles/compare_squire.html">Squire Validation Run</a>
    </li>
    <li>
      <a href="../articles/differential_nat.html">Advanced options</a>
    </li>
    <li>
      <a href="../articles/natural_immunity.html">Natural Immunity</a>
    </li>
    <li>
      <a href="../articles/vaccine_notypes.html">Vaccine model with multiple doses</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/safir/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Natural Immunity</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/safir/blob/HEAD/vignettes/natural_immunity.Rmd" class="external-link"><code>vignettes/natural_immunity.Rmd</code></a></small>
      <div class="hidden name"><code>natural_immunity.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/safir" class="external-link">safir</a></span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/safir" class="external-link">safir</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/individual" class="external-link">individual</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">nimue</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'nimue'</span>
<span class="co">#&gt; The following object is masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     format</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></code></pre></div>
<div class="section level1">
<h1 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h1>
<p>This vignette is essentially identical to the one titled “Vaccine model with multiple doses”, but includes options for modeling immune response mechanistically (a boost to antibody titre as the result of natural infection) as opposed to with an R compartment within which agents are 100% immune for re-infection. The only thing that needs to be added to the <code>parameters</code> list is <code>parameters$mu_ab_infection</code>, giving the antibody boost derived from each natural infection. It is a vector where the 1st element is the antibody boost from someone’s first infection, 2nd from someone’s second subsequent infection, and so on. If an individual is getting reinfected a number of times greater than the length of the vector, the last element of the vector is used as their antibody titre associated with that reinfection event.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iso3c</span> <span class="op">&lt;-</span> <span class="st">"GBR"</span>
<span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu">safir</span><span class="fu">::</span><span class="fu"><a href="../reference/get_population.html">get_population</a></span><span class="op">(</span><span class="va">iso3c</span><span class="op">)</span>
<span class="va">pop</span><span class="op">$</span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">pop</span><span class="op">$</span><span class="va">n</span> <span class="op">/</span> <span class="fl">1e3</span><span class="op">)</span>
<span class="va">contact_mat</span> <span class="op">&lt;-</span> <span class="fu">squire</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/squire/man/get_mixing_matrix.html" class="external-link">get_mixing_matrix</a></span><span class="op">(</span>iso3c <span class="op">=</span> <span class="va">iso3c</span><span class="op">)</span>

<span class="va">tmax</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">0.5</span>
<span class="va">R0</span> <span class="op">&lt;-</span> <span class="fl">4</span>

<span class="co"># vaccine dosing</span>
<span class="va">vaccine_doses</span> <span class="op">&lt;-</span> <span class="fl">2</span>
<span class="va">dose_period</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NaN</span>, <span class="fl">28</span><span class="op">)</span>
<span class="va">vaccine_set</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">1e3</span>, to <span class="op">=</span> <span class="fl">1e4</span>, length.out <span class="op">=</span> <span class="va">tmax</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">vaccine_set</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">vaccine_set</span><span class="op">)</span>

<span class="co"># vaccine strategy</span>
<span class="va">vaccine_coverage_mat</span> <span class="op">&lt;-</span> <span class="fu">nimue</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nimue/man/strategy_matrix.html" class="external-link">strategy_matrix</a></span><span class="op">(</span>strategy <span class="op">=</span> <span class="st">"Elderly"</span>,max_coverage <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>
<span class="va">next_dose_priority</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">vaccine_doses</span> <span class="op">-</span> <span class="fl">1</span>,ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">vaccine_coverage_mat</span><span class="op">)</span><span class="op">)</span>
<span class="va">next_dose_priority</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">15</span><span class="op">:</span><span class="fl">17</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># prioritize 3 oldest age groups for next dose</span>

<span class="co"># base parameters</span>
<span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu">safir</span><span class="fu">::</span><span class="fu"><a href="../reference/get_parameters.html">get_parameters</a></span><span class="op">(</span>
  population <span class="op">=</span> <span class="va">pop</span><span class="op">$</span><span class="va">n</span>,
  contact_matrix_set <span class="op">=</span> <span class="va">contact_mat</span>,
  iso3c <span class="op">=</span> <span class="va">iso3c</span>,
  R0 <span class="op">=</span> <span class="va">R0</span>,
  time_period <span class="op">=</span> <span class="va">tmax</span>,
  dt <span class="op">=</span> <span class="va">dt</span>
<span class="op">)</span>

<span class="co"># vaccine parameters</span>
<span class="va">ab_parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_vaccine_ab_titre_parameters.html">get_vaccine_ab_titre_parameters</a></span><span class="op">(</span>vaccine <span class="op">=</span> <span class="st">"Pfizer"</span>, max_dose <span class="op">=</span> <span class="va">vaccine_doses</span>,correlated <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># combine parameters and verify</span>
<span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_vaccine_parameters.html">make_vaccine_parameters</a></span><span class="op">(</span>
  safir_parameters <span class="op">=</span> <span class="va">parameters</span>,
  vaccine_ab_parameters <span class="op">=</span> <span class="va">ab_parameters</span>,
  vaccine_set <span class="op">=</span> <span class="va">vaccine_set</span>,
  dose_period <span class="op">=</span> <span class="va">dose_period</span>,
  strategy_matrix <span class="op">=</span> <span class="va">vaccine_coverage_mat</span>,
  next_dose_priority_matrix <span class="op">=</span> <span class="va">next_dose_priority</span>
<span class="op">)</span>

<span class="co"># ab boost for each infection</span>
<span class="va">parameters</span><span class="op">$</span><span class="va">mu_ab_infection</span> <span class="op">&lt;-</span> <span class="va">ab_parameters</span><span class="op">$</span><span class="va">mu_ab</span></code></pre></div>
</div>
<div class="section level1">
<h1 id="run-safir">Run <strong>safir</strong><a class="anchor" aria-label="anchor" href="#run-safir"></a>
</h1>
<p>This part is also exactly the same as the “Vaccine model with multiple doses” except the following places:</p>
<ol style="list-style-type: decimal">
<li>
<code>create_natural_immunity_variables</code> is called to attach additional variables to the <code>variables</code> list needed to model multiple infections</li>
<li>
<code>attach_event_listeners_natural_immunity</code> is called to add additional event listeners to <code>events</code> list needd to antibody boosting. Please note there is an argument <code>additive</code> which can be used to change how antibody boosting from infection interacts with existing antibody titre levels, so please carefully read the documentation for <code><a href="../reference/attach_event_listeners_natural_immunity.html">attach_event_listeners_natural_immunity()</a></code>
</li>
<li>We use another render object, <code>inf_renderer</code> which will plot the number of cumulative infections the population has. Rendering adds more computation, increasing model run time, so for actual use, please don’t add this and its associated process function <code>integer_count_render_process_daily</code> unless you are interested in tracking this information.</li>
<li>
<code>natural_immunity_ab_titre_process</code> is added to the <code>processes</code> list to update antibody titre from vaccines or natural immunity (replaces <code>vaccine_ab_titre_process</code>).</li>
</ol>
<p>As usual, for actual use, please use only the minimum number of output/rendering needed for your analysis, as it increases run time. In particular, <code>double_count_render_process_daily</code> to output the antibody titre for each person each day is time consuming.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create variables</span>
<span class="va">timesteps</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">$</span><span class="va">time_period</span><span class="op">/</span><span class="va">dt</span>
<span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_variables.html">create_variables</a></span><span class="op">(</span>pop <span class="op">=</span> <span class="va">pop</span>, parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span>
<span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_vaccine_variables.html">create_vaccine_variables</a></span><span class="op">(</span>variables <span class="op">=</span> <span class="va">variables</span>,parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span>
<span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_natural_immunity_variables.html">create_natural_immunity_variables</a></span><span class="op">(</span>variables <span class="op">=</span> <span class="va">variables</span>, parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span>

<span class="co"># create events</span>
<span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_events.html">create_events</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span>
<span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_events_vaccination.html">create_events_vaccination</a></span><span class="op">(</span>events <span class="op">=</span> <span class="va">events</span>,parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span>
<span class="fu"><a href="../reference/attach_event_listeners.html">attach_event_listeners</a></span><span class="op">(</span>variables <span class="op">=</span> <span class="va">variables</span>,events <span class="op">=</span> <span class="va">events</span>,parameters <span class="op">=</span> <span class="va">parameters</span>, dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>
<span class="fu"><a href="../reference/attach_event_listeners_vaccination.html">attach_event_listeners_vaccination</a></span><span class="op">(</span>variables <span class="op">=</span> <span class="va">variables</span>,events <span class="op">=</span> <span class="va">events</span>,parameters <span class="op">=</span> <span class="va">parameters</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>
<span class="fu"><a href="../reference/attach_event_listeners_natural_immunity.html">attach_event_listeners_natural_immunity</a></span><span class="op">(</span>variables <span class="op">=</span> <span class="va">variables</span>, events <span class="op">=</span> <span class="va">events</span>, parameters <span class="op">=</span> <span class="va">parameters</span>, dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>

<span class="co"># make renderers</span>
<span class="va">renderer</span> <span class="op">&lt;-</span> <span class="va"><a href="https://mrc-ide.github.io/individual/reference/Render.html" class="external-link">Render</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">time_period</span><span class="op">)</span>
<span class="va">nat_renderer</span> <span class="op">&lt;-</span> <span class="va"><a href="https://mrc-ide.github.io/individual/reference/Render.html" class="external-link">Render</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">time_period</span><span class="op">)</span>
<span class="va">dose_renderer</span> <span class="op">&lt;-</span> <span class="va"><a href="https://mrc-ide.github.io/individual/reference/Render.html" class="external-link">Render</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">time_period</span><span class="op">)</span>

<span class="va">double_count_render_process_daily</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">renderer</span>, <span class="va">variable</span>, <span class="va">dt</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">variable</span>, <span class="st">"DoubleVariable"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">renderer</span>, <span class="st">"Render"</span><span class="op">)</span><span class="op">)</span>
  <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="op">(</span><span class="va">t</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">1</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">day</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">t</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span>
      <span class="va">nat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">variable</span><span class="op">$</span><span class="fu">get_values</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
      <span class="va">quantiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">nat</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span>
      <span class="va">renderer</span><span class="op">$</span><span class="fu">render</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"q025"</span>, value <span class="op">=</span> <span class="va">quantiles</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, timestep <span class="op">=</span> <span class="va">day</span><span class="op">)</span>
      <span class="va">renderer</span><span class="op">$</span><span class="fu">render</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"q5"</span>, value <span class="op">=</span> <span class="va">quantiles</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, timestep <span class="op">=</span> <span class="va">day</span><span class="op">)</span>
      <span class="va">renderer</span><span class="op">$</span><span class="fu">render</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"q975"</span>, value <span class="op">=</span> <span class="va">quantiles</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>, timestep <span class="op">=</span> <span class="va">day</span><span class="op">)</span>
      <span class="va">renderer</span><span class="op">$</span><span class="fu">render</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"mean"</span>, value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">nat</span><span class="op">)</span>, timestep <span class="op">=</span> <span class="va">day</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="va">inf_renderer</span> <span class="op">&lt;-</span> <span class="va"><a href="https://mrc-ide.github.io/individual/reference/Render.html" class="external-link">Render</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">time_period</span><span class="op">)</span>

<span class="co"># processes</span>
<span class="va">processes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/natural_immunity_ab_titre_process.html">natural_immunity_ab_titre_process</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span>,variables <span class="op">=</span> <span class="va">variables</span>, dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/vaccination_process.html">vaccination_process</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span>,variables <span class="op">=</span> <span class="va">variables</span>,events <span class="op">=</span> <span class="va">events</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/infection_process_vaccine_cpp.html">infection_process_vaccine_cpp</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span>,variables <span class="op">=</span> <span class="va">variables</span>,events <span class="op">=</span> <span class="va">events</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/categorical_count_renderer_process_daily.html">categorical_count_renderer_process_daily</a></span><span class="op">(</span>renderer <span class="op">=</span> <span class="va">renderer</span>,variable <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">states</span>,categories <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">states</span><span class="op">$</span><span class="fu">get_categories</span><span class="op">(</span><span class="op">)</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>,
  <span class="fu">double_count_render_process_daily</span><span class="op">(</span>renderer <span class="op">=</span> <span class="va">nat_renderer</span>, variable <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">ab_titre</span>, dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/integer_count_render_process_daily.html">integer_count_render_process_daily</a></span><span class="op">(</span>renderer <span class="op">=</span> <span class="va">dose_renderer</span>,variable <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">dose_num</span>,margin <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="va">vaccine_doses</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/integer_count_render_process_daily.html">integer_count_render_process_daily</a></span><span class="op">(</span>renderer <span class="op">=</span> <span class="va">inf_renderer</span>,variable <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">inf_num</span>,margin <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">51</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="../reference/setup_events.html">setup_events</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span>,events <span class="op">=</span> <span class="va">events</span>,variables <span class="op">=</span> <span class="va">variables</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span></code></pre></div>
<p>Run the simulation.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="fu"><a href="../reference/simulation_loop_safir.html">simulation_loop_safir</a></span><span class="op">(</span>
    variables <span class="op">=</span> <span class="va">variables</span>,
    events <span class="op">=</span> <span class="va">events</span>,
    processes <span class="op">=</span> <span class="va">processes</span>,
    timesteps <span class="op">=</span> <span class="va">timesteps</span>,
    variables_dont_update <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"discrete_age"</span>, <span class="st">"phase"</span><span class="op">)</span>,
    progress <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;  20.049   0.077  20.136</span></code></pre></div>
<div class="section level2">
<h2 id="plot-results">Plot Results<a class="anchor" aria-label="anchor" href="#plot-results"></a>
</h2>
<div class="section level3">
<h3 id="antibody-titre">Antibody titre<a class="anchor" aria-label="anchor" href="#antibody-titre"></a>
</h3>
<p>This lets us check if people are getting vaccinated; Ab titre, averaged over the population, relative to the time of the first dose. It won’t look like the cohort plots because everybody gets their second dose at slightly different times, depending on availability.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ab_titre_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">nat_renderer</span><span class="op">$</span><span class="fu">to_dataframe</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">ab_titre_dt</span>, <span class="st">"timestep"</span>, <span class="st">"Day"</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ab_titre_dt</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Day</span>,y<span class="op">=</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Day</span>,ymin<span class="op">=</span><span class="va">q025</span>,ymax<span class="op">=</span><span class="va">q975</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="natural_immunity_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="proportion-of-population-with-each-dose">Proportion of population with each dose<a class="anchor" aria-label="anchor" href="#proportion-of-population-with-each-dose"></a>
</h3>
<p>We also want to plot the number of people with each dose over time to check it’s working.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dose_out</span> <span class="op">&lt;-</span> <span class="va">dose_renderer</span><span class="op">$</span><span class="fu">to_dataframe</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dose_out</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="va">vaccine_doses</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="va">vaccine_doses</span><span class="op">)</span>
<span class="va">dose_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">dose_out</span><span class="op">)</span>,id.vars<span class="op">=</span><span class="st">"timestep"</span><span class="op">)</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">dose_out</span>, <span class="st">"variable"</span>, <span class="st">"dose"</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dose_out</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">timestep</span>,y<span class="op">=</span><span class="va">value</span>,color<span class="op">=</span><span class="va">dose</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="natural_immunity_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="infection-states">Infection states<a class="anchor" aria-label="anchor" href="#infection-states"></a>
</h3>
<p>The compartmental states of the model.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">saf_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">renderer</span><span class="op">$</span><span class="fu">to_dataframe</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">saf_dt</span><span class="op">[</span>, <span class="va">IMild_count</span> <span class="op">:=</span> <span class="va">IMild_count</span> <span class="op">+</span> <span class="va">IAsymp_count</span><span class="op">]</span>
<span class="va">saf_dt</span><span class="op">[</span>, <span class="va">IAsymp_count</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span>
<span class="va">saf_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">saf_dt</span>,id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"timestep"</span><span class="op">)</span>,variable.name <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span>
<span class="va">saf_dt</span><span class="op">[</span>, <span class="va">name</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"(^)(\\w*)(_count)"</span>, <span class="st">"\\2"</span>, <span class="va">name</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">saf_dt</span>,old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"timestep"</span>,<span class="st">"name"</span>,<span class="st">"value"</span><span class="op">)</span>,new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"t"</span>,<span class="st">"compartment"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">saf_dt</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">t</span>,<span class="va">y</span>,color <span class="op">=</span> <span class="va">compartment</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">compartment</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></code></pre></div>
<p><img src="natural_immunity_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="cumulative-infections">Cumulative infections<a class="anchor" aria-label="anchor" href="#cumulative-infections"></a>
</h3>
<p>Here we plot how many people in the population have had 0,1,2,… infections.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># infections</span>
<span class="va">inf_out</span> <span class="op">&lt;-</span> <span class="va">inf_renderer</span><span class="op">$</span><span class="fu">to_dataframe</span><span class="op">(</span><span class="op">)</span>
<span class="va">inf_out</span> <span class="op">&lt;-</span> <span class="va">inf_out</span><span class="op">[</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">inf_out</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">x</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">}</span>, USE.NAMES <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="va">inf_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">inf_out</span><span class="op">)</span>
<span class="va">inf_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">inf_out</span>, id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"timestep"</span><span class="op">)</span>,variable.name <span class="op">=</span> <span class="st">"infections"</span><span class="op">)</span>
<span class="va">inf_out</span><span class="op">[</span>, <span class="va">infections</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"(^X)(\\w*)(_count)"</span>, <span class="st">"\\2"</span>, <span class="va">infections</span><span class="op">)</span><span class="op">]</span>
<span class="va">inf_out</span><span class="op">[</span>, <span class="va">t</span> <span class="op">:=</span> <span class="va">timestep</span> <span class="op">*</span> <span class="va">dt</span><span class="op">]</span>
<span class="va">inf_out</span><span class="op">[</span>, <span class="va">timestep</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">inf_out</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">t</span>,<span class="va">value</span>,color <span class="op">=</span> <span class="va">infections</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.25</span>, alpha <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span></code></pre></div>
<p><img src="natural_immunity_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
</div>
</div>
<div class="section level1">
<h1 id="code-design">Code design<a class="anchor" aria-label="anchor" href="#code-design"></a>
</h1>
<p>The new code is in:</p>
<ol style="list-style-type: decimal">
<li>R/efficacy_naturalimmunity.R: contains <code>natural_immunity_ab_titre_process</code>, <code>get_time_since_last_dose_or_infection</code> (helper function)</li>
<li>R/events_naturalimmunity.R: contains <code>attach_event_listeners_natural_immunity</code>
</li>
<li>R/variables_naturalimmunity.R: contains <code>create_natural_immunity_variables</code>
</li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Sean L. Wu, OJ Watson, Peter Winskill.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
