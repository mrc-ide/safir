<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nimue Validation Run • safir</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Nimue Validation Run">
<meta property="og:description" content="safir">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">safir</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/code_design.html">Code Design</a>
    </li>
    <li>
      <a href="../articles/compare_nimue.html">Nimue Validation Run</a>
    </li>
    <li>
      <a href="../articles/compare_squire.html">Squire Validation Run</a>
    </li>
    <li>
      <a href="../articles/vaccine_notypes.html">Vaccine model with multiple doses</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/safir/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="compare_nimue_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Nimue Validation Run</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/safir/blob/master/vignettes/compare_nimue.Rmd"><code>vignettes/compare_nimue.Rmd</code></a></small>
      <div class="hidden name"><code>compare_nimue.Rmd</code></div>

    </div>

    
    
<div id="setup" class="section level1">
<h1 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h1>
<p>Let’s compare <strong>safir</strong> to <strong>nimue</strong>. Set up our parameters for running. We use a time step of 0.1 days.</p>
<p>Do a run of <strong>nimue</strong> with increasing vaccination.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/safir">safir</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">nimue</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'nimue'</span>
<span class="co">#&gt; The following object is masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     format</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/individual">individual</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>

<span class="va">iso3c</span> <span class="op">&lt;-</span> <span class="st">"GBR"</span>
<span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu">safir</span><span class="fu">::</span><span class="fu"><a href="../reference/get_population.html">get_population</a></span><span class="op">(</span><span class="va">iso3c</span><span class="op">)</span>
<span class="va">pop</span><span class="op">$</span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">pop</span><span class="op">$</span><span class="va">n</span> <span class="op">/</span> <span class="fl">2e2</span><span class="op">)</span>
<span class="va">contact_mat</span> <span class="op">&lt;-</span> <span class="fu">squire</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/squire/man/get_mixing_matrix.html">get_mixing_matrix</a></span><span class="op">(</span>iso3c <span class="op">=</span> <span class="va">iso3c</span><span class="op">)</span>

<span class="va">tmax</span> <span class="op">&lt;-</span> <span class="fl">200</span>
<span class="va">R0</span> <span class="op">&lt;-</span> <span class="fl">4</span>

<span class="co"># nimue run</span>
<span class="va">increasing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nimue/man/run.html">run</a></span><span class="op">(</span>
  time_period <span class="op">=</span> <span class="va">tmax</span>,
  population <span class="op">=</span> <span class="va">pop</span><span class="op">$</span><span class="va">n</span>,
  R0 <span class="op">=</span> <span class="va">R0</span>,
  contact_matrix_set <span class="op">=</span> <span class="va">contact_mat</span>,
  max_vaccine <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">1e4</span>, length.out <span class="op">=</span> <span class="fl">40</span><span class="op">)</span><span class="op">)</span>,
  tt_vaccine <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">50</span>, length.out <span class="op">=</span> <span class="fl">40</span><span class="op">)</span><span class="op">)</span>,
  vaccine_efficacy_disease <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">17</span><span class="op">)</span>,
  vaccine_efficacy_infection <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.9</span>, <span class="fl">17</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="run-safir" class="section level1">
<h1 class="hasAnchor">
<a href="#run-safir" class="anchor"></a>Run <strong>safir</strong>
</h1>
<p>Do a <strong>safir</strong> run. Because running the individual based verion of <strong>nimue</strong> is computationally expensive, we use <code>categorical_count_renderer_process_daily</code> and <code>integer_count_render_process_daily</code> to only render output every day (as opposed to each timestep, which increment by 0.1). In addition, we use the C++ processes <code>vaccination_process_nimue_cpp</code> and <code>infection_process_nimue_cpp</code> (R versions are <code>vaccination_process_nimue</code> and <code>infection_process_nimue_cpp</code>; tests are included in the package to ensure the same results are returned when using identical random number seeds).</p>
<p>The function <code>get_parameters_nimue</code> grabs parameters directly from the <strong>nimue</strong> package. Then make the basic <strong>squire</strong> transmission model variables using <code>create_variables</code>. Then, attach additional variables to model <strong>nimue</strong> vaccines using <code>create_vaccine_variables_nimue</code>. The same routine is used to make events, calling <code>create_events</code> and <code>create_events_nimue</code>. Listeners are attached similarly.</p>
<p>Next, make renderer objects. Note that because we are only outputting simulation state every day despite the time step size, the number of time steps is equal to the number of days, not the total number of time steps taken. The process list can then be made, and finally <code>setup_events_nimue</code> is called to queue initial events (this allows the model to be initialized from any valid state, not just S and E individuals).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>

<span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_parameters_nimue.html">get_parameters_nimue</a></span><span class="op">(</span>
  population <span class="op">=</span> <span class="va">pop</span><span class="op">$</span><span class="va">n</span>,
  contact_mat <span class="op">=</span> <span class="va">contact_mat</span>,
  time_period <span class="op">=</span> <span class="va">tmax</span>,
  R0 <span class="op">=</span> <span class="va">R0</span>,
  max_vaccine <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">1e4</span>, length.out <span class="op">=</span> <span class="fl">40</span><span class="op">)</span><span class="op">)</span>,
  tt_vaccine <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">50</span>, length.out <span class="op">=</span> <span class="fl">40</span><span class="op">)</span><span class="op">)</span>,
  vaccine_efficacy_disease <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">17</span><span class="op">)</span>,
  vaccine_efficacy_infection <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.9</span>, <span class="fl">17</span><span class="op">)</span>,
  dt <span class="op">=</span> <span class="va">dt</span>
<span class="op">)</span>

<span class="va">timesteps</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">$</span><span class="va">time_period</span><span class="op">/</span><span class="va">dt</span>

<span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_variables.html">create_variables</a></span><span class="op">(</span>pop <span class="op">=</span> <span class="va">pop</span>, parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span>
<span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_vaccine_variables_nimue.html">create_vaccine_variables_nimue</a></span><span class="op">(</span>variables <span class="op">=</span> <span class="va">variables</span>,pop <span class="op">=</span> <span class="va">pop</span><span class="op">)</span>

<span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_events.html">create_events</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span>
<span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_events_nimue.html">create_events_nimue</a></span><span class="op">(</span>events <span class="op">=</span> <span class="va">events</span>,parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span>

<span class="fu"><a href="../reference/attach_event_listeners.html">attach_event_listeners</a></span><span class="op">(</span>variables <span class="op">=</span> <span class="va">variables</span>,events <span class="op">=</span> <span class="va">events</span>,parameters <span class="op">=</span> <span class="va">parameters</span>, dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>
<span class="fu"><a href="../reference/attach_event_listeners_nimue.html">attach_event_listeners_nimue</a></span><span class="op">(</span>variables <span class="op">=</span> <span class="va">variables</span>,events <span class="op">=</span> <span class="va">events</span>,parameters <span class="op">=</span> <span class="va">parameters</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>

<span class="va">renderer</span> <span class="op">&lt;-</span> <span class="va"><a href="https://mrc-ide.github.io/individual/reference/Render.html">Render</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">time_period</span><span class="op">)</span>
<span class="va">vaxx_renderer</span> <span class="op">&lt;-</span> <span class="va"><a href="https://mrc-ide.github.io/individual/reference/Render.html">Render</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">time_period</span><span class="op">)</span>
<span class="va">processes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/vaccination_process_nimue_cpp.html">vaccination_process_nimue_cpp</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span>,variables <span class="op">=</span> <span class="va">variables</span>,events <span class="op">=</span> <span class="va">events</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/infection_process_nimue_cpp.html">infection_process_nimue_cpp</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span>,variables <span class="op">=</span> <span class="va">variables</span>,events <span class="op">=</span> <span class="va">events</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/categorical_count_renderer_process_daily.html">categorical_count_renderer_process_daily</a></span><span class="op">(</span>renderer <span class="op">=</span> <span class="va">renderer</span>, variable <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">state</span>, categories <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">states</span><span class="op">$</span><span class="fu">get_categories</span><span class="op">(</span><span class="op">)</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/integer_count_render_process_daily.html">integer_count_render_process_daily</a></span><span class="op">(</span>renderer <span class="op">=</span> <span class="va">vaxx_renderer</span>,variable <span class="op">=</span> <span class="va">variables</span><span class="op">$</span><span class="va">vaccine_states</span>,margin <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="../reference/setup_events_nimue.html">setup_events_nimue</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">parameters</span>,events <span class="op">=</span> <span class="va">events</span>,variables <span class="op">=</span> <span class="va">variables</span>,dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/simulation_loop_nimue.html">simulation_loop_nimue</a></span><span class="op">(</span>
    variables <span class="op">=</span> <span class="va">variables</span>,
    events <span class="op">=</span> <span class="va">events</span>,
    processes <span class="op">=</span> <span class="va">processes</span>,
    timesteps <span class="op">=</span> <span class="va">timesteps</span>,
    progress <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;  49.922   2.719  52.684</span></code></pre></div>
<div id="plot-vaccinations" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-vaccinations" class="anchor"></a>Plot vaccinations</h2>
<p>Compare vaccinations. These are spot-on.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">safir_vax_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">vaxx_renderer</span><span class="op">$</span><span class="fu">to_dataframe</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">safir_vax_dt</span><span class="op">[</span> , <span class="st">"vaccinated"</span> <span class="op">:=</span> <span class="va">X2_count</span> <span class="op">+</span> <span class="va">X3_count</span> <span class="op">]</span>
<span class="va">safir_vax_dt</span><span class="op">[</span> , <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X2_count"</span>,<span class="st">"X3_count"</span><span class="op">)</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">safir_vax_dt</span>,old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X1_count"</span>,<span class="st">"X4_count"</span><span class="op">)</span>,new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"unvaccinated"</span>,<span class="st">"priorvaccinated"</span><span class="op">)</span><span class="op">)</span>
<span class="va">safir_vax_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt</a></span><span class="op">(</span><span class="va">safir_vax_dt</span>,id.vars <span class="op">=</span> <span class="st">"timestep"</span>,variable.name <span class="op">=</span> <span class="st">"compartment"</span><span class="op">)</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span><span class="op">(</span><span class="va">safir_vax_dt</span>,old <span class="op">=</span> <span class="st">"timestep"</span>,new <span class="op">=</span> <span class="st">"t"</span><span class="op">)</span>
<span class="va">safir_vax_dt</span><span class="op">[</span>, <span class="st">"model"</span> <span class="op">:=</span> <span class="st">"safir"</span><span class="op">]</span>

<span class="va">nimue_vax_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nimue/man/format.html">format</a></span><span class="op">(</span><span class="va">increasing</span>, compartments <span class="op">=</span> <span class="cn">NULL</span>,summaries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"unvaccinated"</span>,<span class="st">"vaccinated"</span>,<span class="st">"priorvaccinated"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">nimue_vax_dt</span><span class="op">[</span>, <span class="va">replicate</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span>
<span class="va">nimue_vax_dt</span><span class="op">[</span>, <span class="st">"model"</span> <span class="op">:=</span> <span class="st">"nimue"</span><span class="op">]</span>

<span class="va">combined_vax_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbind</a></span><span class="op">(</span><span class="va">safir_vax_dt</span>,<span class="va">nimue_vax_dt</span><span class="op">)</span></code></pre></div>
<p>plot it.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">combined_vax_dt</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>,y<span class="op">=</span><span class="va">value</span>,color<span class="op">=</span><span class="va">compartment</span>,linetype<span class="op">=</span><span class="va">model</span>,group<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="va">.</span><span class="op">~</span><span class="va">compartment</span>,scales<span class="op">=</span><span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>strip.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span>,face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Warning: `guides(&lt;scale&gt; = FALSE)` is deprecated. Please use `guides(&lt;scale&gt; =</span>
<span class="co">#&gt; "none")` instead.</span></code></pre></div>
<p><img src="compare_nimue_files/figure-html/unnamed-chunk-5-1.png" width="864"></p>
</div>
<div id="plot-compartments" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-compartments" class="anchor"></a>Plot compartments</h2>
<p>Compare state (compartments) output. Because <strong>nimue</strong> is an ODE model the convergence of <strong>safir</strong> to it’s results is highly dependent upon the size of dt. Smaller dt will lead to more similar results. The stochastic version of <strong>squire</strong>, on the other hand, uses a discretization of the continuous time Markov process so results should look exactly identical between those two with the same dt.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># extract data - state</span>
<span class="va">safir_compartments</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"S"</span>,<span class="st">"E"</span>,<span class="st">"D"</span>,<span class="st">"R"</span>,<span class="st">"IMild"</span>,<span class="st">"ICase"</span>,<span class="st">"IRec"</span>,<span class="st">"IOxGetDie"</span>,<span class="st">"IOxNotGetDie"</span>,<span class="st">"IOxNotGetLive"</span>,<span class="st">"IOxGetLive"</span>,<span class="st">"IMVNotGetDie"</span>,<span class="st">"IMVNotGetLive"</span>,<span class="st">"IMVGetLive"</span>,<span class="st">"IMVGetDie"</span><span class="op">)</span>
<span class="va">nimue_compartments</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"S"</span>,<span class="st">"E"</span>,<span class="st">"D"</span>,<span class="st">"R"</span>,<span class="st">"IMild"</span>,<span class="st">"ICase"</span>,<span class="st">"IRec"</span>,<span class="st">"IICU"</span>,<span class="st">"IHospital"</span><span class="op">)</span>

<span class="va">df</span> <span class="op">&lt;-</span> <span class="va">renderer</span><span class="op">$</span><span class="fu">to_dataframe</span><span class="op">(</span><span class="op">)</span>
<span class="va">safir_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>
<span class="va">safir_dt</span><span class="op">[</span>, <span class="va">IMild_count</span> <span class="op">:=</span> <span class="va">IMild_count</span> <span class="op">+</span> <span class="va">IAsymp_count</span><span class="op">]</span>
<span class="va">safir_dt</span><span class="op">[</span>, <span class="va">IAsymp_count</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span>
<span class="va">safir_dt</span><span class="op">[</span>, <span class="va">IICU_count</span> <span class="op">:=</span> <span class="va">IMVNotGetDie_count</span> <span class="op">+</span> <span class="va">IMVNotGetLive_count</span> <span class="op">+</span> <span class="va">IMVGetLive_count</span> <span class="op">+</span> <span class="va">IMVGetDie_count</span><span class="op">]</span>
<span class="va">safir_dt</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"IMVNotGetDie_count"</span>,<span class="st">"IMVNotGetLive_count"</span>,<span class="st">"IMVGetLive_count"</span>,<span class="st">"IMVGetDie_count"</span><span class="op">)</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span>
<span class="va">safir_dt</span><span class="op">[</span>, <span class="va">IHospital</span> <span class="op">:=</span> <span class="va">IOxGetDie_count</span> <span class="op">+</span> <span class="va">IOxNotGetDie_count</span> <span class="op">+</span> <span class="va">IOxNotGetLive_count</span> <span class="op">+</span> <span class="va">IOxGetLive_count</span><span class="op">]</span>
<span class="va">safir_dt</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"IOxGetDie_count"</span>, <span class="st">"IOxNotGetDie_count"</span>, <span class="st">"IOxNotGetLive_count"</span>, <span class="st">"IOxGetLive_count"</span><span class="op">)</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span>
<span class="va">safir_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt</a></span><span class="op">(</span><span class="va">safir_dt</span>,id.vars <span class="op">=</span> <span class="st">"timestep"</span>,variable.name <span class="op">=</span> <span class="st">"compartment"</span>,value.name <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span>
<span class="va">safir_dt</span><span class="op">[</span>, <span class="va">compartment</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"(^)(\\w*)(_count)"</span>, <span class="st">"\\2"</span>, <span class="va">compartment</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span><span class="op">(</span><span class="va">safir_dt</span>,old <span class="op">=</span> <span class="st">"timestep"</span>,new <span class="op">=</span> <span class="st">"t"</span><span class="op">)</span>
<span class="va">safir_dt</span> <span class="op">&lt;-</span> <span class="va">safir_dt</span><span class="op">[</span><span class="va">compartment</span> <span class="op">%in%</span> <span class="va">nimue_compartments</span>, <span class="op">]</span>
<span class="va">safir_dt</span><span class="op">[</span> ,<span class="st">"model"</span> <span class="op">:=</span> <span class="st">"safir"</span><span class="op">]</span>

<span class="va">nimue_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nimue/man/format.html">format</a></span><span class="op">(</span><span class="va">increasing</span>, compartments <span class="op">=</span> <span class="va">nimue_compartments</span><span class="op">)</span><span class="op">)</span>
<span class="va">nimue_dt</span><span class="op">[</span> , <span class="va">replicate</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span>
<span class="va">nimue_dt</span> <span class="op">&lt;-</span> <span class="va">nimue_dt</span><span class="op">[</span><span class="va">compartment</span> <span class="op">%in%</span> <span class="va">nimue_compartments</span>, <span class="op">]</span>
<span class="va">nimue_dt</span><span class="op">[</span> ,<span class="st">"model"</span> <span class="op">:=</span> <span class="st">"nimue"</span><span class="op">]</span>

<span class="va">combined_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbind</a></span><span class="op">(</span><span class="va">nimue_dt</span>,<span class="va">safir_dt</span><span class="op">)</span></code></pre></div>
<p>plot it.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">combined_dt</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>,y<span class="op">=</span><span class="va">value</span>,color<span class="op">=</span><span class="va">compartment</span>,group<span class="op">=</span><span class="va">model</span>,linetype<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="va">.</span><span class="op">~</span><span class="va">compartment</span>,scales<span class="op">=</span><span class="st">"free_y"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>strip.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span>,face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Warning: `guides(&lt;scale&gt; = FALSE)` is deprecated. Please use `guides(&lt;scale&gt; =</span>
<span class="co">#&gt; "none")` instead.</span></code></pre></div>
<p><img src="compare_nimue_files/figure-html/unnamed-chunk-7-1.png" width="864"></p>
</div>
<div id="ensemble-plot" class="section level2">
<h2 class="hasAnchor">
<a href="#ensemble-plot" class="anchor"></a>Ensemble plot</h2>
<p>This is the same run as above, but with 40 repetitions. 95% quantiles and means are plotted for <strong>safir</strong>.</p>
<p><img src="nimue_comparison.png" width="100%"></p>
</div>
</div>
<div id="code-design" class="section level1">
<h1 class="hasAnchor">
<a href="#code-design" class="anchor"></a>Code design</h1>
<div id="parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#parameters" class="anchor"></a>Parameters</h2>
<p>The function <code>get_parameters_nimue</code> is used to generate parameters from the nimue model, and source code is in R/parameters_nimue.R.</p>
</div>
<div id="variables" class="section level2">
<h2 class="hasAnchor">
<a href="#variables" class="anchor"></a>Variables</h2>
<p>The function <code>create_vaccine_variables_nimue</code> adds additional information needed for the model to the output of <code>create_variables</code>. It can be found in R/variables_vaccines.R.</p>
</div>
<div id="events-processes" class="section level2">
<h2 class="hasAnchor">
<a href="#events-processes" class="anchor"></a>Events &amp; Processes</h2>
<p>The function <code>create_events_nimue</code> attaches additional events for modeling the vaccination process to the events list. <code>attach_event_listeners_nimue</code> attaches additional listeners to the vaccination events. Both functions can be found in R/events_vaccination_nimue.R.</p>
<p><code>setup_events_nimue</code> initializes event scheduling based on the initial state of the model. This is needed so that the model can be initialized from any valid state, instead of just <strong>S</strong> and <strong>E</strong> persons who are unvaccinated. It can be found in R/initialize_events_nimue.R.</p>
<p>The infection process can either use an R implementation <code>infection_process_nimue</code> or C++ implementation <code>infection_process_nimue_cpp</code>. The R version is in R/process_infection_nimue.R and the C++ one in src/process_infection_nimue.cpp.</p>
<p>Likewise the vaccination process has the R version <code>vaccination_process_nimue</code> and <code>vaccination_process_nimue_cpp</code>, in R/process_vaccination_nimue.R and src/process_vaccination_nimue.cpp, respectively.</p>
</div>
<div id="simulation" class="section level2">
<h2 class="hasAnchor">
<a href="#simulation" class="anchor"></a>Simulation</h2>
<p>Because the variables list used for the simulation contains some bitset objects which are not variables, the function <code>simulation_loop_nimue</code> is used to run the simulation to handle variable updating correctly. It can be found in r/simulation_loop_nimue.R.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by OJ Watson, Peter Winskill, Sean L. Wu.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
