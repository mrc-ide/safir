<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modeling of antibody titre and immunity • safir</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Modeling of antibody titre and immunity">
<meta property="og:description" content="safir">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">safir</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.6.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/antibody_efficacy.html">Modeling of antibody titre and immunity</a>
    </li>
    <li>
      <a href="../articles/compare_nimue.html">Nimue Validation Run</a>
    </li>
    <li>
      <a href="../articles/compare_squire.html">Squire Validation Run</a>
    </li>
    <li>
      <a href="../articles/differential_nat.html">Advanced options</a>
    </li>
    <li>
      <a href="../articles/natural_immunity.html">Natural Immunity</a>
    </li>
    <li>
      <a href="../articles/vaccine_notypes.html">Vaccine model with multiple doses</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/safir/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Modeling of antibody titre and immunity</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/safir/blob/HEAD/vignettes/antibody_efficacy.Rmd" class="external-link"><code>vignettes/antibody_efficacy.Rmd</code></a></small>
      <div class="hidden name"><code>antibody_efficacy.Rmd</code></div>

    </div>

    
    
<p>This vignette will explain how antibody titre dynamics are modeled in <strong>safir</strong>, and how they are affected by vaccination and (optionally) natural immunity from infection bouts. Furthermore it will explain how protective efficacy against infection and severe disease, and the effect on infectiousness is calculated from an individual’s antibody titre.</p>
<div class="section level2">
<h2 id="antibody-dynamics">Antibody dynamics<a class="anchor" aria-label="anchor" href="#antibody-dynamics"></a>
</h2>
<p>The variables needed to store antibody titre are created in <code>create_vaccine_variables</code>, in R/variables_vaccines.R, attached to the variable list <code>variables$ab_titre</code>. The antibody titre decays and that process is <code>vaccine_ab_titre_process</code> (R/efficacy_vaccination.R) or <code>natural_immunity_ab_titre_process</code> (R/ efficacy_naturalimmunity.R), depending on if you are modeling natural immunity or not.</p>
<p>Each day, an individual’s antibody titre decays at a rate given by the vector <code>parameters$dr_vec</code>, giving the daily rate of decay since last vaccine dose (or recovery from infection bout, for natural immunity). If the person’s time since last dose (or infection) is greater than the length of the vector, the last value is used. The vector is set in <code>get_vaccine_ab_titre_parameters</code> (R/parameters_vaccine.R).</p>
</div>
<div class="section level2">
<h2 id="titre-associated-with-dose-or-infection">Titre associated with dose or infection<a class="anchor" aria-label="anchor" href="#titre-associated-with-dose-or-infection"></a>
</h2>
<p>The only way that antibody titre can increase is through a vaccine dose or, optionally, natural infection. For vaccination, the mean titre associated with each dose is associated with the particular vaccine product, and is chosen in <code>get_vaccine_ab_titre_parameters</code>. At this point we note that there are two ways to model the actual titre drawn for each individual receiving a dose. By default the value in <code>mu_ab_list</code> for the chosen vaccine product is used. However if <code>correlated = TRUE</code> is used, then the individual’s antibody titre sampled from the previous dose is multiplied by the ratio of the current to previous dose mean titre values.</p>
<p>The function which samples antibody titre for each dose is <code>schedule_dose_vaccine</code> and is in R/events_vaccination.R. Note that if <code>correlated = TRUE</code> was selected then there is an additional variable <code>zdose</code> which holds the previous antibody titre associated with the last vaccine dose for each individual.</p>
<p>Using correlated doses increases memory requirements for the model, and produces nearly identical population level trajectories of antibody titre as uncorrelated, so its use should be weighed against other computational factors.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">schedule_dose_vaccine</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">timestep</span>, <span class="va">variables</span>, <span class="va">target</span>, <span class="va">dose</span>, <span class="va">parameters</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">variables</span><span class="op">$</span><span class="va">dose_num</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>value <span class="op">=</span> <span class="va">dose</span>,index <span class="op">=</span> <span class="va">target</span><span class="op">)</span></span>
<span>  <span class="va">variables</span><span class="op">$</span><span class="va">dose_time</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>values <span class="op">=</span> <span class="va">timestep</span>, index <span class="op">=</span> <span class="va">target</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">target</span>,<span class="st">"Bitset"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="va">target</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">target</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">correlated</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">dose</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># correlated doses &gt; 1; use ratio of mean titre</span></span>
<span>      <span class="va">zdose_prev</span> <span class="op">&lt;-</span> <span class="va">variables</span><span class="op">$</span><span class="va">zdose</span><span class="op">$</span><span class="fu">get_values</span><span class="op">(</span>index <span class="op">=</span> <span class="va">target</span><span class="op">)</span></span>
<span>      <span class="va">zdose_prev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">zdose_prev</span><span class="op">)</span><span class="op">)</span> <span class="co"># transform back to log scale</span></span>
<span>      <span class="va">zdose</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">10</span><span class="op">^</span><span class="va">zdose_prev</span> <span class="op">*</span> <span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">mu_ab</span><span class="op">[</span><span class="va">dose</span><span class="op">]</span> <span class="op">/</span> <span class="va">parameters</span><span class="op">$</span><span class="va">mu_ab</span><span class="op">[</span><span class="va">dose</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">variables</span><span class="op">$</span><span class="va">zdose</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>values <span class="op">=</span> <span class="va">zdose</span>, index <span class="op">=</span> <span class="va">target</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># initial dose</span></span>
<span>      <span class="va">zdose</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">mu_ab</span><span class="op">[</span><span class="va">dose</span><span class="op">]</span><span class="op">)</span>,sd <span class="op">=</span> <span class="va">parameters</span><span class="op">$</span><span class="va">std10</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">variables</span><span class="op">$</span><span class="va">zdose</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>values <span class="op">=</span> <span class="va">zdose</span>, index <span class="op">=</span> <span class="va">target</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># uncorrelated doses (also use for dose 1 of correlated dose titre)</span></span>
<span>    <span class="va">zdose</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">mu_ab</span><span class="op">[</span><span class="va">dose</span><span class="op">]</span><span class="op">)</span>,sd <span class="op">=</span> <span class="va">parameters</span><span class="op">$</span><span class="va">std10</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">variables</span><span class="op">$</span><span class="va">ab_titre</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>values <span class="op">=</span> <span class="va">zdose</span>, index <span class="op">=</span> <span class="va">target</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For antibody titre driven by natural immunity, the recovered (R) class of completely immune individuals used in the compartmental model to simulated complete immunity with Exponential or Erlang distributed wait time before transition back to susceptible (S) is now simply used as a state from which to compute the antibody titre associated with that individual’s natural immune response to infection.</p>
<p>This requires two additional variable objects, <code>num_inf</code> which tracks how many infections each individual has experienced, and <code>inf_time</code>, the time since last infection. These variables are made in <code>create_natural_immunity_variables</code> (R/variables_naturalimmunity.R).</p>
<p>Upon entering the R compartment, individuals will transition back to S on the next time step (as time steps are usually much less than one day, this is not a problem). During that time event listeners are called which draw the antibody titre associated with this infection bout and update <code>ab_titre</code>. Of note is that the vector <code>parameters$mu_ab_infection</code> controls the mean antibody titre associated with each re-infection event, in case antibody response varies from the first to subsequent re-infections, and can be set by the user. The user can optionally specify <code>parameters$std10_infection</code> to control the variance of the sampled values, but if not specified it will use the <code>std10</code> parameter for vaccines.</p>
<p>Antibody titre boost associated with recovery can either be overwriting or additive, controlled by the <code>additive</code> parameter in <code>attach_event_listeners_natural_immunity</code>.</p>
<p>The function <code><a href="../reference/attach_event_listeners_natural_immunity.html">attach_event_listeners_natural_immunity()</a></code> is found in R/events_naturalimmunity.R.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">attach_event_listeners_natural_immunity</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">variables</span>, <span class="va">events</span>, <span class="va">parameters</span>, <span class="va">dt</span>, <span class="va">additive</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">is.logical</a></span><span class="op">(</span><span class="va">additive</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">mu_ab_infection</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">mu_ab_infection</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">std10_infection</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">std10_infection</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">$</span><span class="va">std10</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">std10_infection</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">std10_infection</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">std10_infection</span> <span class="op">&lt;-</span> <span class="va">parameters</span><span class="op">$</span><span class="va">std10_infection</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># recovery: handle 1 timestep R-&gt;S and update ab titre for immune response</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">events</span><span class="op">$</span><span class="va">recovery</span><span class="op">$</span><span class="va">.listeners</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">events</span><span class="op">$</span><span class="va">recovery</span><span class="op">$</span><span class="va">.listeners</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># they go from R to S in 1 time step</span></span>
<span>  <span class="va">events</span><span class="op">$</span><span class="va">recovery</span><span class="op">$</span><span class="fu">add_listener</span><span class="op">(</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">timestep</span>, <span class="va">target</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">events</span><span class="op">$</span><span class="va">immunity_loss</span><span class="op">$</span><span class="fu">schedule</span><span class="op">(</span>target <span class="op">=</span> <span class="va">target</span>, delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">target</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># effect of infection on NAT</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">additive</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">events</span><span class="op">$</span><span class="va">recovery</span><span class="op">$</span><span class="fu">add_listener</span><span class="op">(</span></span>
<span>      <span class="kw">function</span><span class="op">(</span><span class="va">timestep</span>, <span class="va">target</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>        <span class="co"># update inf_num</span></span>
<span>        <span class="va">inf</span> <span class="op">&lt;-</span> <span class="va">variables</span><span class="op">$</span><span class="va">inf_num</span><span class="op">$</span><span class="fu">get_values</span><span class="op">(</span><span class="va">target</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1L</span></span>
<span>        <span class="va">variables</span><span class="op">$</span><span class="va">inf_num</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>values <span class="op">=</span> <span class="va">inf</span>, index <span class="op">=</span> <span class="va">target</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># update last time of infection</span></span>
<span>        <span class="va">variables</span><span class="op">$</span><span class="va">inf_time</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>values <span class="op">=</span> <span class="va">timestep</span>, index <span class="op">=</span> <span class="va">target</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># get NAT values and convert to linear scale</span></span>
<span>        <span class="va">current_ab_titre</span> <span class="op">&lt;-</span> <span class="va">variables</span><span class="op">$</span><span class="va">ab_titre</span><span class="op">$</span><span class="fu">get_values</span><span class="op">(</span>index <span class="op">=</span> <span class="va">target</span><span class="op">)</span></span>
<span>        <span class="va">current_ab_titre</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">current_ab_titre</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># draw NAT boost on linear scale</span></span>
<span>        <span class="va">inf</span><span class="op">[</span><span class="va">inf</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">mu_ab_infection</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">mu_ab_infection</span><span class="op">)</span></span>
<span>        <span class="va">zdose</span> <span class="op">&lt;-</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">target</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">mu_ab_infection</span><span class="op">[</span><span class="va">inf</span><span class="op">]</span><span class="op">)</span>,sd <span class="op">=</span> <span class="va">std10_infection</span><span class="op">)</span></span>
<span>        <span class="va">new_ab_titre</span> <span class="op">&lt;-</span> <span class="va">current_ab_titre</span> <span class="op">+</span> <span class="va">zdose</span></span>
<span></span>
<span>        <span class="co"># back to ln scale, and impose max value constraint</span></span>
<span>        <span class="va">new_ab_titre</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">new_ab_titre</span><span class="op">)</span></span>
<span>        <span class="va">new_ab_titre</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">new_ab_titre</span>, <span class="va">parameters</span><span class="op">$</span><span class="va">max_ab</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># queue NAT update</span></span>
<span>        <span class="va">variables</span><span class="op">$</span><span class="va">ab_titre</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>values <span class="op">=</span> <span class="va">new_ab_titre</span>, index <span class="op">=</span> <span class="va">target</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">events</span><span class="op">$</span><span class="va">recovery</span><span class="op">$</span><span class="fu">add_listener</span><span class="op">(</span></span>
<span>      <span class="kw">function</span><span class="op">(</span><span class="va">timestep</span>, <span class="va">target</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># update inf_num</span></span>
<span>        <span class="va">inf</span> <span class="op">&lt;-</span> <span class="va">variables</span><span class="op">$</span><span class="va">inf_num</span><span class="op">$</span><span class="fu">get_values</span><span class="op">(</span><span class="va">target</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1L</span></span>
<span>        <span class="va">variables</span><span class="op">$</span><span class="va">inf_num</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>values <span class="op">=</span> <span class="va">inf</span>, index <span class="op">=</span> <span class="va">target</span><span class="op">)</span></span>
<span>        <span class="co"># draw ab titre value</span></span>
<span>        <span class="va">inf</span><span class="op">[</span><span class="va">inf</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">mu_ab_infection</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">mu_ab_infection</span><span class="op">)</span></span>
<span>        <span class="va">zdose</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">target</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">mu_ab_infection</span><span class="op">[</span><span class="va">inf</span><span class="op">]</span><span class="op">)</span>,sd <span class="op">=</span> <span class="va">std10_infection</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">zdose</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">zdose</span>, <span class="va">parameters</span><span class="op">$</span><span class="va">max_ab</span><span class="op">)</span></span>
<span>        <span class="va">variables</span><span class="op">$</span><span class="va">ab_titre</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>values <span class="op">=</span> <span class="va">zdose</span>, index <span class="op">=</span> <span class="va">target</span><span class="op">)</span></span>
<span>        <span class="co"># update last time of infection</span></span>
<span>        <span class="va">variables</span><span class="op">$</span><span class="va">inf_time</span><span class="op">$</span><span class="fu">queue_update</span><span class="op">(</span>values <span class="op">=</span> <span class="va">timestep</span>, index <span class="op">=</span> <span class="va">target</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="efficacy-against-infection">Efficacy against infection<a class="anchor" aria-label="anchor" href="#efficacy-against-infection"></a>
</h2>
<p>Efficacy against infection is used to adjust the per-capita force of infection in the function <code>infection_process_vaccine</code> (R/process_infection_vaccine.R). The relevant code snippet is here:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get infection modifier and ages</span></span>
<span><span class="va">ab_titre</span> <span class="op">&lt;-</span> <span class="va">variables</span><span class="op">$</span><span class="va">ab_titre</span><span class="op">$</span><span class="fu">get_values</span><span class="op">(</span><span class="va">susceptible</span><span class="op">)</span></span>
<span><span class="va">infection_efficacy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vaccine_efficacy_infection_cpp.html">vaccine_efficacy_infection_cpp</a></span><span class="op">(</span>ab_titre <span class="op">=</span> <span class="va">ab_titre</span>,parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span></span>
<span><span class="va">ages</span> <span class="op">&lt;-</span> <span class="va">variables</span><span class="op">$</span><span class="va">discrete_age</span><span class="op">$</span><span class="fu">get_values</span><span class="op">(</span><span class="va">susceptible</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># FoI for each susceptible based on their age group</span></span>
<span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="va">lambda</span> <span class="op">+</span> <span class="op">(</span><span class="va">lambda_age</span><span class="op">[</span><span class="va">ages</span><span class="op">]</span> <span class="op">*</span> <span class="va">infection_efficacy</span><span class="op">)</span></span></code></pre></div>
<p>The function that computes efficacy against infection is <code>vaccine_efficacy_infection</code> (R/efficacy_vaccination.R) but for speed we use <code>vaccine_efficacy_infection_cpp</code> (src/efficacy_vaccination.cpp).</p>
<p>The relevant (R) code is here:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">ab_titre</span><span class="op">[</span><span class="va">finite_ab</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">ef_infection</span><span class="op">[</span><span class="va">finite_ab</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">parameters</span><span class="op">$</span><span class="va">k</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">nt</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">ab_50</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># reported efficacy in trials</span></span>
<span><span class="va">ef_infection</span><span class="op">[</span><span class="va">finite_ab</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">ef_infection</span><span class="op">[</span><span class="va">finite_ab</span><span class="op">]</span></span></code></pre></div>
<p><code>nt</code> is the antibody titre of each person converted back to the linear scale. The trial efficacy is <span class="math inline">\(\frac{1}{1 + e^{-k(\log_{10}(nt) - \log_{10}(ab_{50}))}}\)</span>. The protective efficacy is <span class="math inline">\(1\)</span> minus this.</p>
<p>Note that we only compute this for individuals with finite antibody titre, <strong>safir</strong> uses <code>-Inf</code> as a null placeholder for persons who do not yet have antibodies.</p>
</div>
<div class="section level2">
<h2 id="efficacy-against-severe-disease">Efficacy against severe disease<a class="anchor" aria-label="anchor" href="#efficacy-against-severe-disease"></a>
</h2>
<p>Efficacy against severe disease adjusts the probability of a person once infected to experience a severe disease outcome. It is used in <code>create_exposure_scheduler_listener_vaccine</code> (R/events_exposure_vaccine.R), and the relevant code snippet is here. Note that we first need to compute efficacy against infection, because efficacy against severe disease is conditional upon this.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># vaccine efficacy against severe disease</span></span>
<span><span class="va">ab_titre</span> <span class="op">&lt;-</span> <span class="va">variables</span><span class="op">$</span><span class="va">ab_titre</span><span class="op">$</span><span class="fu">get_values</span><span class="op">(</span><span class="va">hosp</span><span class="op">)</span></span>
<span><span class="va">infection_efficacy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vaccine_efficacy_infection_cpp.html">vaccine_efficacy_infection_cpp</a></span><span class="op">(</span>ab_titre <span class="op">=</span> <span class="va">ab_titre</span>,parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span></span>
<span><span class="va">severe_efficacy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vaccine_efficacy_severe_cpp.html">vaccine_efficacy_severe_cpp</a></span><span class="op">(</span>ab_titre <span class="op">=</span> <span class="va">ab_titre</span>,ef_infection <span class="op">=</span> <span class="va">infection_efficacy</span>,parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># sample those with severe disease</span></span>
<span><span class="va">hosp</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span><span class="va">prob_hosp</span> <span class="op">*</span> <span class="va">severe_efficacy</span><span class="op">)</span></span></code></pre></div>
<p>The function that computes efficacy against infection is <code>vaccine_efficacy_severe</code> (R/efficacy_vaccination.R) but for speed we use <code>vaccine_efficacy_severe_cpp</code> (src/efficacy_vaccination.cpp).</p>
<p>The relevant (R) code is here:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">finite_ab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">ab_titre</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">ab_titre</span><span class="op">[</span><span class="va">finite_ab</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">ef_severe_uncond</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">parameters</span><span class="op">$</span><span class="va">k</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">nt</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">ab_50_severe</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ef_severe</span><span class="op">[</span><span class="va">finite_ab</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="fl">1</span> <span class="op">-</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">ef_severe_uncond</span><span class="op">)</span><span class="op">/</span><span class="va">ef_infection</span><span class="op">[</span><span class="va">finite_ab</span><span class="op">]</span><span class="op">)</span> <span class="co"># 1 - (1 - ef_infection) goes from hazard reduction scale to efficacy, simplifies to ef_infection</span></span>
<span><span class="va">ef_severe</span><span class="op">[</span><span class="va">finite_ab</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">ef_severe</span><span class="op">[</span><span class="va">finite_ab</span><span class="op">]</span></span></code></pre></div>
<p><code>nt</code> is the linear scale antibody titre. Unconditional protection against severe disease is computed as <span class="math inline">\(\frac{1}{1 + e^{-k(\log_{10}(nt) - \log_{10}(ab\:\text{severe}_{50}))}}\)</span>. Because this is computing for individuals who <em>have been infected</em> we need to make it conditional on being infected, which we do by <code>1 - ((1 - ef_severe_uncond)/(1 - (1 - ef_infection)))</code> where <code>1 - ef_infection</code> goes from hazard reduction scale to trial efficiency scale, and it simplifies to <code>ef_infection</code>.</p>
<p>Finally we set <code>ef_severe &lt;- 1 - ef_severe</code> so we are on the proper hazard reduction scale for efficacy against severe disease.</p>
</div>
<div class="section level2">
<h2 id="efficacy-against-onward-infection">Efficacy against onward infection<a class="anchor" aria-label="anchor" href="#efficacy-against-onward-infection"></a>
</h2>
<p>Antibody titre can (optionally) be used to adjust the contribution of each infectious person to the overall force of infection on susceptible persons. It can be turned on or off, and strength of the effect controlled with parameters set in <code>get_vaccine_ab_titre_parameters</code>.</p>
<p>It affects the computation of the number of infectious persons by age group in <code>infection_process_vaccine</code> (R/process_infection_vaccine.R):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># group infectious persons by age</span></span>
<span><span class="va">inf_ages</span> <span class="op">&lt;-</span> <span class="fu">get_inf_ages</span><span class="op">(</span>infection_bset <span class="op">=</span> <span class="va">infectious</span>, variables <span class="op">=</span> <span class="va">variables</span>, parameters <span class="op">=</span> <span class="va">parameters</span><span class="op">)</span></span></code></pre></div>
<p>The relevant (R) code is here:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">ab_titre</span><span class="op">[</span><span class="va">finite_ab</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">ef_transmission</span><span class="op">[</span><span class="va">finite_ab</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">parameters</span><span class="op">$</span><span class="va">k</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">nt</span> <span class="op">/</span> <span class="va">parameters</span><span class="op">$</span><span class="va">nt_transmission_factor</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">$</span><span class="va">ab_50</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># reported efficacy in trials</span></span>
<span><span class="va">ef_transmission</span><span class="op">[</span><span class="va">finite_ab</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">ef_transmission</span><span class="op">[</span><span class="va">finite_ab</span><span class="op">]</span></span></code></pre></div>
<p><code>nt</code> is the antibody titre of each person converted back to the linear scale. The trial efficacy is <span class="math inline">\(\frac{1}{1 + e^{-k(\log_{10}(nt/\text{nt_transmission_factor}) - \log_{10}(ab_{50}))}}\)</span>. The effect on each person’s onward contribution of infectiousness is <code>1 - ef_transmission</code>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Sean L. Wu, OJ Watson, Peter Winskill.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
